<template>
  <div class="migrate-page" @click="handlePageClick">
    <!-- Header -->
    <div class="header">
      <button @click="goBack" class="back-btn">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
          <path d="M19 12H5M12 19L5 12L12 5" stroke="white" stroke-width="2" stroke-linecap="round"
            stroke-linejoin="round" />
        </svg>
      </button>
      <h1 class="page-title">Account Migration</h1>
      <div class="placeholder"></div>
    </div>

    <!-- Content -->
    <div class="content">
      <div class="welcome-section">
        <p class="welcome-subtitle">Please set a new password to secure your account</p>
      </div>

      <form @submit.prevent="handleMigration" class="migrate-form" @click.stop>
        <div class="form-group">
          <label for="email" class="form-label">Email</label>
          <input id="email" v-model="formData.email" type="email" class="form-input" placeholder="Your email address"
            disabled />
        </div>

        <div class="form-group">
          <label for="password" class="form-label">New Password</label>
          <div class="password-input-wrapper">
            <input id="password" v-model="formData.password" :type="showPassword ? 'text' : 'password'"
              class="form-input" placeholder="Enter new password" required minlength="6" autofocus />
            <button type="button" @click="togglePassword" class="password-toggle">
              <svg v-if="showPassword" width="20" height="20" viewBox="0 0 24 24" fill="none"
                xmlns="http://www.w3.org/2000/svg">
                <path d="M1 12S5 4 12 4S23 12 23 12S19 20 12 20S1 12 1 12Z" stroke="currentColor" stroke-width="2"
                  stroke-linecap="round" stroke-linejoin="round" />
                <circle cx="12" cy="12" r="3" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                  stroke-linejoin="round" />
              </svg>
              <svg v-else width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path d="M2 12C2 12 6 4 12 4C18 4 22 12 22 12C22 12 18 20 12 20C6 20 2 12 2 12Z" stroke="currentColor"
                  stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
                <path
                  d="M12 15C13.6569 15 15 13.6569 15 12C15 10.3431 13.6569 9 12 9C10.3431 9 9 10.3431 9 12C9 13.6569 10.3431 15 12 15Z"
                  stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
                <path d="M2 2L22 22" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                  stroke-linejoin="round" />
              </svg>
            </button>
          </div>
          <div class="password-requirements">
            <small>Password must be at least 6 characters long</small>
          </div>
        </div>

        <div class="form-group">
          <label for="confirmPassword" class="form-label">Confirm New Password</label>
          <div class="password-input-wrapper">
            <input id="confirmPassword" v-model="formData.confirmPassword"
              :type="showConfirmPassword ? 'text' : 'password'" class="form-input" placeholder="Confirm new password"
              required minlength="6" />
            <button type="button" @click="toggleConfirmPassword" class="password-toggle">
              <svg v-if="showConfirmPassword" width="20" height="20" viewBox="0 0 24 24" fill="none"
                xmlns="http://www.w3.org/2000/svg">
                <path d="M1 12S5 4 12 4S23 12 23 12S19 20 12 20S1 12 1 12Z" stroke="currentColor" stroke-width="2"
                  stroke-linecap="round" stroke-linejoin="round" />
                <circle cx="12" cy="12" r="3" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                  stroke-linejoin="round" />
              </svg>
              <svg v-else width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path d="M2 12C2 12 6 4 12 4C18 4 22 12 22 12C22 12 18 20 12 20C6 20 2 12 2 12Z" stroke="currentColor"
                  stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
                <path
                  d="M12 15C13.6569 15 15 13.6569 15 12C15 10.3431 13.6569 9 12 9C10.3431 9 9 10.3431 9 12C9 13.6569 10.3431 15 12 15Z"
                  stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
                <path d="M2 2L22 22" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                  stroke-linejoin="round" />
              </svg>
            </button>
          </div>
        </div>

        <!-- Password validation feedback -->
        <div v-if="formData.password && formData.confirmPassword" class="validation-feedback">
          <div v-if="formData.password !== formData.confirmPassword" class="error-feedback">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
              <path d="M18 6L6 18M6 6L18 18" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                stroke-linejoin="round" />
            </svg>
            Passwords do not match
          </div>
          <div v-else class="success-feedback">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
              <path d="M20 6L9 17L4 12" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                stroke-linejoin="round" />
            </svg>
            Passwords match
          </div>
        </div>

        <button type="submit" class="migrate-btn" :disabled="loading || !canSubmit">
          <span v-if="loading">Migrating Account...</span>
          <span v-else>Complete Migration</span>
        </button>
      </form>

      <!-- Migration Notice -->
      <div class="migration-notice">
        <div class="notice-icon">
          <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path
              d="M12 22C17.5228 22 22 17.5228 22 12C22 6.47715 17.5228 2 12 2C6.47715 2 2 6.47715 2 12C2 17.5228 6.47715 22 12 22Z"
              stroke="#2196F3" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
            <path d="M12 8V12" stroke="#2196F3" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
            <path d="M12 16H12.01" stroke="#2196F3" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
          </svg>
        </div>
        <p class="notice-text">
          We're upgrading our security system. Please create a new password to continue using your account.
        </p>
      </div>

      <div class="help-section">
        <p class="help-text">Need help? <a href="#" class="help-link">Contact Support</a></p>
      </div>
    </div>
  </div>
</template>

<script setup>
import { ref, reactive, computed, onMounted } from 'vue'
import { useRouter } from 'vue-router'
import { Keyboard } from '@capacitor/keyboard'
import { Capacitor } from '@capacitor/core'
import { useNotificationStore } from '../../stores/notifications'
import { useRegistrationStore } from '../../stores/registration'
import { httpsCallable } from 'firebase/functions'
import { functions } from '../../boot/firebase'

// Component name for ESLint
defineOptions({
  name: 'MigrateAccountPage',
})

const router = useRouter()
const notificationStore = useNotificationStore()
const registrationStore = useRegistrationStore()
const loading = ref(false)
const showPassword = ref(false)
const showConfirmPassword = ref(false)

const formData = reactive({
  email: '',
  password: '',
  confirmPassword: '',
})

onMounted(() => {
  // Get email from registration store
  const email = registrationStore.personalData.email
  if (!email) {
    notificationStore.showError('No email found. Please try signing in again.')
    router.push('/signin')
    return
  }
  formData.email = email
})

const goBack = () => {
  router.push('/signin')
}

const handlePageClick = async () => {
  // Dismiss keyboard when clicking outside form (iOS/Android)
  if (Capacitor.isNativePlatform()) {
    try {
      await Keyboard.hide()
    } catch {
      // Keyboard API might not be available, ignore error
    }
  }
}

const togglePassword = () => {
  showPassword.value = !showPassword.value
}

const toggleConfirmPassword = () => {
  showConfirmPassword.value = !showConfirmPassword.value
}

const canSubmit = computed(() => {
  return (
    formData.email &&
    formData.password &&
    formData.confirmPassword &&
    formData.password === formData.confirmPassword &&
    formData.password.length >= 6 &&
    !loading.value
  )
})

const handleMigration = async () => {
  if (loading.value) return

  // Validate inputs
  if (!formData.password || formData.password.length < 6) {
    notificationStore.showError('Password must be at least 6 characters long')
    return
  }

  if (formData.password !== formData.confirmPassword) {
    notificationStore.showError('Passwords do not match')
    return
  }

  loading.value = true

  try {
    console.log('[MigrateAccount] Starting migration for:', formData.email)

    // On iOS, Cloud Functions consistently fail - skip them and use direct migration
    const isIOS = Capacitor.getPlatform() === 'ios'
    
    if (isIOS) {
      console.log('[MigrateAccount] 📱 iOS detected - using direct migration (Cloud Functions not reliable on iOS)')
      await handleDirectMigration()
      return
    }

    // On other platforms, try Cloud Function first
    console.log('[MigrateAccount] Calling Cloud Function with 30s timeout...')
    
    const migrateOldUser = httpsCallable(functions, 'migrateOldUser', {
      timeout: 30000, // 30 seconds timeout
    })

    // Create timeout promise
    const timeoutPromise = new Promise((_, reject) => {
      setTimeout(() => {
        reject(new Error('Migration request timed out after 30 seconds. Please check your network connection and try again.'))
      }, 30000)
    })

    // Race between function call and timeout
    const functionCall = migrateOldUser({
      email: formData.email,
      password: formData.password,
    })

    const result = await Promise.race([functionCall, timeoutPromise])

    console.log('[MigrateAccount] ✅ Migration successful:', result.data)

    // Clear stored email
    registrationStore.setPersonalData({ email: '' })

    // Show success message
    notificationStore.showSuccess('Account migrated successfully! Please sign in with your new password.')

    // Redirect to sign in
    setTimeout(() => {
      router.push('/signin')
    }, 1000)
  } catch (error) {
    console.error('[MigrateAccount] ❌ Migration error:', error)
    console.error('[MigrateAccount] Error details:', {
      code: error.code,
      message: error.message,
      name: error.name
    })

    // Check if should trigger fallback
    const shouldUseFallback = error.message?.includes('timeout') ||
      error.message?.includes('timed out') ||
      error.code === 'functions/unavailable' ||
      error.code === 'functions/deadline-exceeded'

    console.log('[MigrateAccount] Should use fallback?', shouldUseFallback)

    // If Cloud Function fails, try direct migration
    if (shouldUseFallback) {
      console.warn('[MigrateAccount] ⚠️ Cloud Function failed, trying direct migration...')

      try {
        await handleDirectMigration()
        return
      } catch (directError) {
        console.error('[MigrateAccount] ❌ Direct migration also failed:', directError)
        notificationStore.showError('Migration failed. Please check your network connection and try again.')
        loading.value = false
        return
      }
    }

    let errorMessage = 'Migration failed. Please try again.'

    if (error.code === 'functions/invalid-argument') {
      errorMessage = 'Invalid email or password format.'
    } else if (error.code === 'functions/not-found') {
      errorMessage = 'Account not found or already migrated.'
    } else if (error.code === 'functions/already-exists') {
      errorMessage = 'An account with this email already exists. Please try signing in.'
    } else if (error.code === 'functions/unauthenticated') {
      errorMessage = 'Authentication failed. Please try again.'
    } else if (error.code === 'functions/unavailable') {
      errorMessage = 'Service temporarily unavailable. Please try again later.'
    } else if (error.message) {
      errorMessage = error.message
    }

    notificationStore.showError(errorMessage)
  } finally {
    loading.value = false
  }
}

// Direct migration fallback for iOS when Cloud Functions fail
const handleDirectMigration = async () => {
  console.log('[MigrateAccount] 🔄 Starting direct migration (fallback)...')

  try {
    // Import firestoreService
    const { default: firestoreService } = await import('../../services/firestoreService')

    let authUid
    
    // Check if running on iOS
    const isIOS = Capacitor.getPlatform() === 'ios'
    console.log('[MigrateAccount] Platform:', Capacitor.getPlatform(), 'Using Capacitor:', isIOS)

    if (isIOS) {
      console.log('[MigrateAccount] 📱 Using Capacitor Firebase Auth for iOS...')
      
      // Import Capacitor Firebase Authentication
      const { FirebaseAuthentication } = await import('@capacitor-firebase/authentication')
      
      try {
        // Try to create user with Capacitor plugin
        console.log('[MigrateAccount] Creating user with Capacitor plugin...')
        const result = await FirebaseAuthentication.createUserWithEmailAndPassword({
          email: formData.email,
          password: formData.password,
        })
        authUid = result.user.uid
        console.log('[MigrateAccount] ✅ Auth user created (Capacitor):', authUid)
      } catch (authError) {
        console.log('[MigrateAccount] Capacitor auth error:', authError)
        
        // Check if user already exists
        if (authError.message?.includes('already') || authError.message?.includes('exists')) {
          console.log('[MigrateAccount] ℹ️ User already exists, signing in with Capacitor...')
          
          const signInResult = await FirebaseAuthentication.signInWithEmailAndPassword({
            email: formData.email,
            password: formData.password,
          })
          
          authUid = signInResult.user.uid
          console.log('[MigrateAccount] ✅ Got existing user UID (Capacitor):', authUid)
        } else {
          throw authError
        }
      }
    } else {
      console.log('[MigrateAccount] 🌐 Using Web SDK for authentication...')
      
      // Import Firebase Auth Web SDK
      const { createUserWithEmailAndPassword, signInWithEmailAndPassword } = await import('firebase/auth')
      const { auth } = await import('../../boot/firebase')

      console.log('[MigrateAccount] Creating Firebase Auth user with 20s timeout...')

      // Create timeout for auth user creation
      const authTimeout = new Promise((_, reject) => {
        setTimeout(() => reject(new Error('Auth user creation timed out')), 20000)
      })

      let userCredential
      
      try {
        // Try to create Firebase Auth user with timeout
        userCredential = await Promise.race([
          createUserWithEmailAndPassword(auth, formData.email, formData.password),
          authTimeout
        ])
        authUid = userCredential.user.uid
        console.log('[MigrateAccount] ✅ Auth user created (Web SDK):', authUid)
      } catch (authError) {
        console.log('[MigrateAccount] Auth creation error:', authError.code, authError.message)
        
        // Check if user already exists
        if (authError.code === 'auth/email-already-in-use' || authError.message?.includes('already')) {
          console.log('[MigrateAccount] ℹ️ User already exists in Auth, signing in to get UID...')
          
          // Sign in to get the UID
          const signInTimeout = new Promise((_, reject) => {
            setTimeout(() => reject(new Error('Sign in timed out')), 15000)
          })
          
          const signInResult = await Promise.race([
            signInWithEmailAndPassword(auth, formData.email, formData.password),
            signInTimeout
          ])
          
          authUid = signInResult.user.uid
          console.log('[MigrateAccount] ✅ Got existing user UID (Web SDK):', authUid)
        } else {
          // Rethrow if it's a different error
          throw authError
        }
      }
    }

    // Find old user document in Firestore
    console.log('[MigrateAccount] Finding old user document in Firestore...')

    // Create timeout for Firestore getDocs
    const getDocsTimeout = new Promise((_, reject) => {
      setTimeout(() => reject(new Error('Firestore getDocs timed out')), 15000)
    })

    // Use firestoreService to get user by email (more reliable on iOS)
    const result = await Promise.race([
      firestoreService.getDocs('users', {
        filters: [{ field: 'email', operator: '==', value: formData.email.toLowerCase().trim() }],
      }),
      getDocsTimeout
    ])

    if (!result || result.empty || result.docs.length === 0) {
      throw new Error('User document not found in Firestore')
    }

    const oldUserDocId = result.docs[0].id
    // Get data - handle both function and object formats
    const oldUserData = typeof result.docs[0].data === 'function' ? result.docs[0].data() : result.docs[0].data
    console.log('[MigrateAccount] Found old user document:', oldUserDocId)

    // Create new user document at users/<authUid> with data from old document
    console.log('[MigrateAccount] Creating new user document at users/' + authUid)
    
    // Prepare new user data (copy from old, update metadata)
    const newUserData = {
      ...oldUserData,
      migrated: true,
      oldDocumentId: oldUserDocId, // Reference to old document
      authUid: authUid,
      updatedAt: new Date().toISOString()
    }
    
    // Remove oldId from the new document (it's now in oldDocumentId)
    delete newUserData.oldId
    
    // Create timeout for Firestore setDoc
    const setDocTimeout = new Promise((_, reject) => {
      setTimeout(() => reject(new Error('Firestore setDoc timed out')), 10000)
    })
    
    // Create the new document
    await Promise.race([
      firestoreService.setDoc(`users/${authUid}`, newUserData),
      setDocTimeout
    ])
    
    console.log('[MigrateAccount] ✅ New user document created at users/' + authUid)
    
    // Delete old document to avoid duplicates
    console.log('[MigrateAccount] Deleting old document to avoid duplicates...')
    const deleteOldTimeout = new Promise((_, reject) => {
      setTimeout(() => reject(new Error('Firestore delete old doc timed out')), 10000)
    })
    
    await Promise.race([
      firestoreService.deleteDoc(`users/${oldUserDocId}`),
      deleteOldTimeout
    ])
    
    console.log('[MigrateAccount] ✅ Old document deleted:', oldUserDocId)

    console.log('[MigrateAccount] ✅ Direct migration successful!')

    // Clear stored email
    registrationStore.setPersonalData({ email: '' })

    // Show success message
    notificationStore.showSuccess('Account migrated successfully! Please sign in with your new password.')

    // Redirect to sign in
    setTimeout(() => {
      router.push('/signin')
    }, 1000)

  } catch (error) {
    console.error('[MigrateAccount] ❌ Direct migration error:', error)
    throw error
  }
}
</script>

<style scoped>
.migrate-page {
  min-height: 100vh;
  background-color: #f8f9fa;
}

.header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 20px;
  background-color: #222222;
  color: white;
}

.back-btn {
  background: none;
  border: none;
  color: white;
  cursor: pointer;
  padding: 8px;
  border-radius: 50%;
  transition: background-color 0.3s ease;
}

.page-title {
  font-size: 1.2rem;
  font-weight: 600;
  margin: 0;
  line-height: 1;
}

.placeholder {
  width: 40px;
}

.content {
  padding: 40px 20px;
  max-width: 400px;
  margin: 0 auto;
}

.welcome-section {
  text-align: center;
  margin-bottom: 30px;
}

.welcome-title {
  font-size: 1.8rem;
  font-weight: 700;
  color: #333;
  margin-bottom: 10px;
}

.welcome-subtitle {
  color: #666;
  font-size: 1rem;
  margin: 0;
}

.migration-notice {
  display: flex;
  align-items: flex-start;
  gap: 15px;
  background-color: #e3f2fd;
  border: 1px solid #90caf9;
  border-radius: 8px;
  padding: 20px;
  margin-bottom: 30px;
}

.notice-icon {
  flex-shrink: 0;
  display: flex;
  align-items: center;
  justify-content: center;
}

.notice-text {
  color: #1565c0;
  font-size: 0.9rem;
  line-height: 1.5;
  margin: 0;
}

.migrate-form {
  margin-bottom: 30px;
}

.form-group {
  margin-bottom: 20px;
}

.form-label {
  display: block;
  margin-bottom: 8px;
  font-weight: 600;
  color: #333;
  font-size: 0.9rem;
}

.form-input {
  width: 100%;
  padding: 15px;
  border: 2px solid #e1e5e9;
  border-radius: 8px;
  font-size: 1rem;
  transition: border-color 0.3s ease;
  box-sizing: border-box;
}

.form-input:focus {
  outline: none;
  border-color: #af1e23;
}

.form-input:disabled {
  background-color: #f5f5f5;
  cursor: not-allowed;
  color: #666;
}

.password-input-wrapper {
  position: relative;
}

.password-toggle {
  position: absolute;
  right: 15px;
  top: 50%;
  transform: translateY(-50%);
  background: none;
  border: none;
  color: #666;
  cursor: pointer;
  padding: 0;
}

.password-requirements {
  margin-top: 5px;
  color: #666;
  font-size: 0.85rem;
}

.validation-feedback {
  margin-bottom: 20px;
}

.error-feedback {
  display: flex;
  align-items: center;
  gap: 8px;
  color: #d32f2f;
  font-size: 0.9rem;
  font-weight: 500;
}

.error-feedback svg {
  stroke: #d32f2f;
  flex-shrink: 0;
}

.success-feedback {
  display: flex;
  align-items: center;
  gap: 8px;
  color: #388e3c;
  font-size: 0.9rem;
  font-weight: 500;
}

.success-feedback svg {
  stroke: #388e3c;
  flex-shrink: 0;
}

.migrate-btn {
  width: 100%;
  background-color: #af1e23;
  color: white;
  border: none;
  padding: 16px;
  border-radius: 8px;
  font-size: 1rem;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.3s ease;
}

.migrate-btn:disabled {
  background-color: #ccc;
  cursor: not-allowed;
}

.help-section {
  text-align: center;
  margin-top: 20px;
}

.help-text {
  color: #666;
  font-size: 0.9rem;
  margin: 0;
}

.help-link {
  color: #af1e23;
  text-decoration: none;
  font-weight: 600;
}

/* Mobile app - hover effects disabled */
/* .help-link:hover {
  text-decoration: underline;
} */

/* Responsive design */
@media (max-width: 480px) {
  .content {
    padding: 30px 15px;
  }

  .welcome-title {
    font-size: 1.6rem;
  }

  .form-input {
    padding: 14px;
  }
}
</style>
