const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/index-BYuuB5GE.js","assets/index-BWVvr855.css","assets/index-DuDlEtNl.js"])))=>i.map(i=>d[i]);
import{W as Z,bJ as O,i as ee,aC as oe,aD as te,aR as se,u as ae,r as z,c as ne,aE as re,b4 as ie,bI as E,ba as le,aH as ce,bg as de,ay as N,_ as A}from"./index-BYuuB5GE.js";var B;(function(w){w.Prompt="PROMPT",w.Camera="CAMERA",w.Photos="PHOTOS"})(B||(B={}));var D;(function(w){w.Rear="REAR",w.Front="FRONT"})(D||(D={}));var H;(function(w){w.Uri="uri",w.Base64="base64",w.DataUrl="dataUrl"})(H||(H={}));class ge extends Z{async getPhoto(a){return new Promise(async(u,o)=>{if(a.webUseInput||a.source===B.Photos)this.fileInputExperience(a,u,o);else if(a.source===B.Prompt){let e=document.querySelector("pwa-action-sheet");e||(e=document.createElement("pwa-action-sheet"),document.body.appendChild(e)),e.header=a.promptLabelHeader||"Photo",e.cancelable=!1,e.options=[{title:a.promptLabelPhoto||"From Photos"},{title:a.promptLabelPicture||"Take Picture"}],e.addEventListener("onSelection",async i=>{i.detail===0?this.fileInputExperience(a,u,o):this.cameraExperience(a,u,o)})}else this.cameraExperience(a,u,o)})}async pickImages(a){return new Promise(async(u,o)=>{this.multipleFileInputExperience(u,o)})}async cameraExperience(a,u,o){if(customElements.get("pwa-camera-modal")){const e=document.createElement("pwa-camera-modal");e.facingMode=a.direction===D.Front?"user":"environment",document.body.appendChild(e);try{await e.componentOnReady(),e.addEventListener("onPhoto",async i=>{const l=i.detail;l===null?o(new O("User cancelled photos app")):l instanceof Error?o(l):u(await this._getCameraPhoto(l,a)),e.dismiss(),document.body.removeChild(e)}),e.present()}catch{this.fileInputExperience(a,u,o)}}else console.error("Unable to load PWA Element 'pwa-camera-modal'. See the docs: https://capacitorjs.com/docs/web/pwa-elements."),this.fileInputExperience(a,u,o)}fileInputExperience(a,u,o){let e=document.querySelector("#_capacitor-camera-input");const i=()=>{var l;(l=e.parentNode)===null||l===void 0||l.removeChild(e)};e||(e=document.createElement("input"),e.id="_capacitor-camera-input",e.type="file",e.hidden=!0,document.body.appendChild(e),e.addEventListener("change",l=>{const n=e.files[0];let C="jpeg";if(n.type==="image/png"?C="png":n.type==="image/gif"&&(C="gif"),a.resultType==="dataUrl"||a.resultType==="base64"){const I=new FileReader;I.addEventListener("load",()=>{if(a.resultType==="dataUrl")u({dataUrl:I.result,format:C});else if(a.resultType==="base64"){const F=I.result.split(",")[1];u({base64String:F,format:C})}i()}),I.readAsDataURL(n)}else u({webPath:URL.createObjectURL(n),format:C}),i()}),e.addEventListener("cancel",l=>{o(new O("User cancelled photos app")),i()})),e.accept="image/*",e.capture=!0,a.source===B.Photos||a.source===B.Prompt?e.removeAttribute("capture"):a.direction===D.Front?e.capture="user":a.direction===D.Rear&&(e.capture="environment"),e.click()}multipleFileInputExperience(a,u){let o=document.querySelector("#_capacitor-camera-input-multiple");const e=()=>{var i;(i=o.parentNode)===null||i===void 0||i.removeChild(o)};o||(o=document.createElement("input"),o.id="_capacitor-camera-input-multiple",o.type="file",o.hidden=!0,o.multiple=!0,document.body.appendChild(o),o.addEventListener("change",i=>{const l=[];for(let n=0;n<o.files.length;n++){const C=o.files[n];let I="jpeg";C.type==="image/png"?I="png":C.type==="image/gif"&&(I="gif"),l.push({webPath:URL.createObjectURL(C),format:I})}a({photos:l}),e()}),o.addEventListener("cancel",i=>{u(new O("User cancelled photos app")),e()})),o.accept="image/*",o.click()}_getCameraPhoto(a,u){return new Promise((o,e)=>{const i=new FileReader,l=a.type.split("/")[1];u.resultType==="uri"?o({webPath:URL.createObjectURL(a),format:l,saved:!1}):(i.readAsDataURL(a),i.onloadend=()=>{const n=i.result;u.resultType==="dataUrl"?o({dataUrl:n,format:l,saved:!1}):o({base64String:n.split(",")[1],format:l,saved:!1})},i.onerror=n=>{e(n)})})}async checkPermissions(){if(typeof navigator>"u"||!navigator.permissions)throw this.unavailable("Permissions API not available in this browser");try{return{camera:(await window.navigator.permissions.query({name:"camera"})).state,photos:"granted"}}catch{throw this.unavailable("Camera permissions are not available in this browser")}}async requestPermissions(){throw this.unimplemented("Not implemented on web.")}async pickLimitedLibraryPhotos(){throw this.unavailable("Not implemented on web.")}async getLimitedLibraryPhotos(){throw this.unavailable("Not implemented on web.")}}const ue=ee("Camera",{web:()=>new ge}),me=Object.assign({name:"ServiceBookingChat"},{__name:"ServiceBookingChat",setup(w){const a=te(),u=se(),o=ae(),e=z(null),i=z(!0),l=z(null),n=u.params.id,C=ne(()=>{const t=e.value?.messages||[];return console.log("🔍 ServiceBookingChat: Messages computed",{messageCount:t.length,messages:t}),t});re(async()=>{console.log("🔍 ServiceBookingChat: Component mounted",{bookingId:n,projectId:o.selectedProject?.id}),await I(),await F()}),ie(()=>{l.value&&l.value()});const I=async()=>{if(console.log("🔍 ServiceBookingChat: loadBooking called",{projectId:o.selectedProject?.id,bookingId:n}),!o.selectedProject?.id||!n){console.log("❌ ServiceBookingChat: Missing project ID or booking ID",{projectId:o.selectedProject?.id,bookingId:n}),i.value=!1;return}try{console.log("🔍 ServiceBookingChat: Loading booking with ID:",n);const t=await E.getServiceBooking(o.selectedProject.id,n);console.log("🔍 ServiceBookingChat: Booking data loaded successfully:",t),e.value=t}catch(t){console.error("❌ ServiceBookingChat: Error loading booking:",t),console.error("❌ ServiceBookingChat: Error details:",{message:t.message,code:t.code,stack:t.stack}),e.value=null}finally{i.value=!1}},F=async()=>{if(!o.selectedProject?.id||!n){console.log("❌ ServiceBookingChat: Cannot setup real-time listener - missing project ID or booking ID");return}try{console.log("🔍 ServiceBookingChat: Setting up real-time listener...");const t=await E.onServiceBookingChange(o.selectedProject.id,n,c=>{if(console.log("🔍 ServiceBookingChat: Realtime booking update received:",{bookingId:c?.id,messageCount:c?.messages?.length||0,lastMessage:c?.messages?.[c.messages.length-1]}),c){const r=(e.value?.messages||[]).filter(g=>g.isTemporary);e.value=c,r.length>0&&(console.log("🔍 ServiceBookingChat: Preserving temporary messages after real-time update"),r.forEach(g=>{c.messages.some(d=>!d.isTemporary&&d.text===g.text&&d.senderType==="user")||e.value.messages.push(g)})),console.log("✅ ServiceBookingChat: Booking updated with real-time data")}else console.log("⚠️ ServiceBookingChat: Received null booking update")});l.value=t,console.log("✅ ServiceBookingChat: Real-time listener setup successfully")}catch(t){console.error("❌ ServiceBookingChat: Error setting up real-time listener:",t),l.value=null}},V=async t=>{if(console.log("🔍 ServiceBookingChat: handleSendMessage called",{messageText:t,bookingId:n,projectId:o.selectedProject.id,booking:e.value}),!e.value){console.error("❌ ServiceBookingChat: No booking available for sending message");return}const c={id:`temp_${Date.now()}`,text:t,senderType:"user",senderId:"current_user",senderName:"You",timestamp:new Date,messageType:"chat",isTemporary:!0};e.value.messages||(e.value.messages=[]),e.value.messages.push(c),console.log("🔍 ServiceBookingChat: Added temporary message to local state");try{console.log("🔍 ServiceBookingChat: Sending message to server..."),await E.addMessage(o.selectedProject.id,n,{text:t,senderType:"user"}),console.log("✅ ServiceBookingChat: Message sent successfully to server"),console.log("🔍 ServiceBookingChat: Keeping temporary message visible");let s=!1;const g=setInterval(()=>{if(s)return;const h=e.value.messages.findIndex(d=>d.id===c.id);h!==-1&&e.value.messages.find(p=>!p.isTemporary&&p.text===t&&p.senderType==="user"&&p.timestamp>c.timestamp)&&(console.log("🔍 ServiceBookingChat: Found real message, removing temporary message"),e.value.messages.splice(h,1),s=!0)},500);setTimeout(()=>{clearInterval(g),s||console.log("🔍 ServiceBookingChat: No real-time update received, keeping temporary message")},5e3)}catch(s){console.error("❌ ServiceBookingChat: Error sending message:",s);const r=e.value.messages.findIndex(g=>g.id===c.id);throw r!==-1&&(e.value.messages.splice(r,1),console.log("🔍 ServiceBookingChat: Removed temporary message due to error")),s}},Y=async t=>{if(console.log("🔍 ServiceBookingChat: handleImageUpload called",{fileName:t?.name||"unknown",fileSize:t?.size||0,fileType:t?.type||"unknown",bookingId:n,projectId:o.selectedProject.id}),!e.value){console.error("❌ ServiceBookingChat: No booking available for image upload");return}const c=N.isNativePlatform(),s=N.getPlatform();return c&&(s==="ios"||s==="android")&&!t?(console.log(`📱 ${s} detected, using Capacitor Camera API...`),await q()):(console.log("🌐 Using provided file for upload..."),await K(t))},W=(t,c=.8)=>new Promise(s=>{const r=document.createElement("canvas"),g=r.getContext("2d"),h=new Image;h.onload=()=>{let{width:b,height:f}=h;(b>1200||f>1200)&&(b>f?(f=f*1200/b,b=1200):(b=b*1200/f,f=1200)),r.width=b,r.height=f,g.drawImage(h,0,0,b,f),r.toBlob(s,"image/jpeg",c)},h.src=URL.createObjectURL(t)}),q=async()=>{try{console.log("📱 Starting Capacitor image picker...");const t=await ue.getPhoto({quality:60,allowEditing:!1,resultType:H.Uri,source:B.Prompt});if(console.log("📱 Image selected:",t),!t.webPath)throw new Error("No image webPath found");console.log("📱 Fetching image as blob from:",t.webPath);let s=await(await fetch(t.webPath)).blob();console.log("📱 Original blob:",{size:s.size,type:s.type}),s.size>1024*1024&&(console.log("📱 Compressing large image..."),s=await W(s,.7),console.log("📱 Compressed blob:",{size:s.size,type:s.type}));const r={id:`temp_image_${Date.now()}`,text:"📎 Uploading image...",senderType:"user",senderId:"current_user",senderName:"You",timestamp:new Date,messageType:"chat",isTemporary:!0,isUploading:!0};e.value.messages||(e.value.messages=[]),e.value.messages.push(r),console.log("📱 Added temporary upload message to local state"),console.log("📱 Ensuring user authentication before upload...");const{getAuth:g,signInAnonymously:h}=await A(async()=>{const{getAuth:m,signInAnonymously:P}=await import("./index-BYuuB5GE.js").then(k=>k.cu);return{getAuth:m,signInAnonymously:P}},__vite__mapDeps([0,1])),d=g();let p=d.currentUser;if(console.log("📱 Current auth state:",{hasUser:!!p,userId:p?.uid,isAnonymous:p?.isAnonymous}),p)console.log("📱 User already authenticated:",{uid:p.uid,isAnonymous:p.isAnonymous});else{console.log("📱 No authenticated user, signing in anonymously...");try{p=(await h(d)).user,console.log("📱 Anonymous sign-in successful:",{uid:p.uid,isAnonymous:p.isAnonymous})}catch(m){throw console.error("📱 Anonymous sign-in failed:",{code:m.code,message:m.message,stack:m.stack}),new Error(`Authentication failed: ${m.message}`)}}const b=`image_${Date.now()}.jpg`,f=`projects/${o.selectedProject.id}/serviceBookings/${n}/images/${b}`;console.log("📱 Starting REST API upload with Blob...",{fullPath:f,blobSize:s.size,blobType:s.type,userId:p.uid,isAnonymous:p.isAnonymous});try{const m=await s.arrayBuffer(),P=new Uint8Array(m);let k="";const x=P.byteLength;for(let v=0;v<x;v++)k+=String.fromCharCode(P[v]);const M=btoa(k);console.log("📱 Converted blob to base64, size:",M.length);const{Http:y}=await A(async()=>{const{Http:v}=await import("./index-DuDlEtNl.js").then(R=>R.i);return{Http:v}},__vite__mapDeps([2,0,1])),U="pre-group.firebasestorage.app",S=`https://firebasestorage.googleapis.com/v0/b/${U}/o?uploadType=media&name=${encodeURIComponent(f)}`;console.log("📱 Uploading to:",S);const _=await y.request({url:S,method:"POST",headers:{"Content-Type":"image/jpeg"},data:M,connectTimeout:6e4,readTimeout:6e4});if(console.log("📱 Upload response status:",_.status),_.status<200||_.status>=300)throw new Error(`Upload failed with status ${_.status}`);const L=`https://firebasestorage.googleapis.com/v0/b/${U}/o/${encodeURIComponent(f)}?alt=media`;console.log("📱 Upload successful! URL:",L);const j=e.value.messages.findIndex(v=>v.id===r.id);j!==-1&&(e.value.messages.splice(j,1),console.log("📱 Removed temporary upload message")),await E.addMessage(o.selectedProject.id,n,{text:`📎 ${b}`,senderType:"user",imageUrl:L}),console.log("✅ Image message sent successfully")}catch(m){console.error("📱 Upload failed with detailed error:",{code:m.code,message:m.message,serverResponse:m.serverResponse,stack:m.stack});const P=e.value.messages.findIndex(k=>k.isTemporary&&k.isUploading);throw P!==-1&&e.value.messages.splice(P,1),await E.addMessage(o.selectedProject.id,n,{text:`❌ Upload failed: ${m.message} (Code: ${m.code||"unknown"})`,senderType:"user"}),m}}catch(t){if(console.error("❌ Capacitor image upload error:",t),(e.value.messages?.filter(s=>s.isTemporary&&s.isUploading)||[]).forEach(s=>{const r=e.value.messages.findIndex(g=>g.id===s.id);r!==-1&&e.value.messages.splice(r,1)}),t.message.includes("Authentication")||t.message.includes("auth")||t.message.includes("timeout")){console.log("📱 Authentication error detected, attempting to refresh auth...");try{const{getAuth:s}=await A(async()=>{const{getAuth:h}=await import("./index-BYuuB5GE.js").then(d=>d.cu);return{getAuth:h}},__vite__mapDeps([0,1])),g=s().currentUser;if(g)return console.log("📱 Refreshing authentication token..."),await g.getIdToken(!0),console.log("📱 Authentication refreshed, retrying upload..."),await q()}catch(s){console.error("📱 Failed to refresh authentication:",s)}}throw await E.addMessage(o.selectedProject.id,n,{text:"❌ Failed to upload image. Please try again.",senderType:"user"}),t}},K=async t=>{const c={id:`temp_image_${Date.now()}`,text:`📎 Uploading ${t.name}...`,senderType:"user",senderId:"current_user",senderName:"You",timestamp:new Date,messageType:"chat",isTemporary:!0,isUploading:!0};e.value.messages||(e.value.messages=[]),e.value.messages.push(c),console.log("🔍 ServiceBookingChat: Added temporary upload message to local state");let s=t;if(t.size>1024*1024){console.log("🌐 Compressing large image...");const r=await W(t,.7);s=new File([r],t.name,{type:"image/jpeg"}),console.log("🌐 Compressed file:",{originalSize:t.size,compressedSize:s.size})}try{console.log("🔍 ServiceBookingChat: Starting image upload..."),console.log("🌐 Ensuring user authentication before upload...");const{getAuth:r,signInAnonymously:g}=await A(async()=>{const{getAuth:y,signInAnonymously:U}=await import("./index-BYuuB5GE.js").then(S=>S.cu);return{getAuth:y,signInAnonymously:U}},__vite__mapDeps([0,1])),h=r();let d=h.currentUser;if(console.log("🌐 Current auth state:",{hasUser:!!d,userId:d?.uid,isAnonymous:d?.isAnonymous}),d)console.log("🌐 User already authenticated:",{uid:d.uid,isAnonymous:d.isAnonymous});else{console.log("🌐 No authenticated user, signing in anonymously...");try{d=(await g(h)).user,console.log("🌐 Anonymous sign-in successful:",{uid:d.uid,isAnonymous:d.isAnonymous})}catch(y){throw console.error("🌐 Anonymous sign-in failed:",{code:y.code,message:y.message,stack:y.stack}),new Error(`Authentication failed: ${y.message}`)}}const p=Date.now(),b=t.name.split(".").pop()||"jpg",f=`image_${p}.${b}`;console.log("🌐 Uploading file:",{fileName:f,fileSize:s.size,fileType:s.type,userId:d.uid});const m=`projects/${o.selectedProject.id}/serviceBookings/${n}/images/${f}`,P=N.isNativePlatform(),k=N.getPlatform();let x;if(P&&(k==="ios"||k==="android")){console.log(`📱 ${k} detected, using Storage REST API for service booking chat...`);const y=await s.arrayBuffer(),U=new Uint8Array(y);let S="";const _=U.byteLength;for(let T=0;T<_;T++)S+=String.fromCharCode(U[T]);const L=btoa(S),{Http:j}=await A(async()=>{const{Http:T}=await import("./index-DuDlEtNl.js").then(X=>X.i);return{Http:T}},__vite__mapDeps([2,0,1])),v="pre-group.firebasestorage.app",R=`https://firebasestorage.googleapis.com/v0/b/${v}/o?uploadType=media&name=${encodeURIComponent(m)}`,$=await j.request({url:R,method:"POST",headers:{"Content-Type":s.type},data:L,connectTimeout:6e4,readTimeout:6e4});if($.status>=200&&$.status<300)x=`https://firebasestorage.googleapis.com/v0/b/${v}/o/${encodeURIComponent(m)}?alt=media`,console.log(`📱 ${k}: ✅ Image uploaded successfully`);else throw new Error(`Upload failed with status ${$.status}`)}else{console.log("🌐 Using Firebase Web SDK for upload...");const{ref:y,uploadBytes:U,getDownloadURL:S}=await A(async()=>{const{ref:v,uploadBytes:R,getDownloadURL:$}=await import("./index-BYuuB5GE.js").then(T=>T.cw);return{ref:v,uploadBytes:R,getDownloadURL:$}},__vite__mapDeps([0,1])),{storage:_}=await A(async()=>{const{storage:v}=await import("./index-BYuuB5GE.js").then(R=>R.cx);return{storage:v}},__vite__mapDeps([0,1])),L=y(_,m),j=await U(L,s);x=await S(j.ref)}console.log("✅ ServiceBookingChat: Image uploaded successfully:",x);const M=e.value.messages.findIndex(y=>y.id===c.id);M!==-1&&(e.value.messages.splice(M,1),console.log("🔍 ServiceBookingChat: Removed temporary upload message")),await E.addMessage(o.selectedProject.id,n,{text:`📎 ${t.name}`,senderType:"user",imageUrl:x}),console.log("✅ ServiceBookingChat: Image message sent successfully")}catch(r){console.error("❌ ServiceBookingChat: Error uploading image:",r);const g=e.value.messages.findIndex(h=>h.id===c.id);throw g!==-1&&(e.value.messages.splice(g,1),console.log("🔍 ServiceBookingChat: Removed temporary upload message due to error")),await E.addMessage(o.selectedProject.id,n,{text:"❌ Failed to upload image. Please try again.",senderType:"user"}),r}},J=()=>{a.go(-1)},G=()=>{console.log("Message sent successfully")},Q=()=>{console.log("Image uploaded successfully")};return(t,c)=>(ce(),le(de,{"chat-data":e.value,messages:C.value,loading:i.value,"chat-type":"service","default-title":"Service Booking Chat","error-title":"Booking Not Found","error-message":"The service booking you're looking for doesn't exist or has been removed.","closed-message":"This service booking has been closed. You can view the conversation but cannot send new messages.","closed-placeholder":"This service booking is closed","on-send-message":V,"on-image-upload":Y,onBack:J,onMessageSent:G,onImageUploaded:Q},null,8,["chat-data","messages","loading"]))}}),he=oe(me,[["__scopeId","data-v-105819de"]]);export{he as default};
