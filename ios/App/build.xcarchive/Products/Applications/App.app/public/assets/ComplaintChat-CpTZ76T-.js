import{aC as X,aD as Z,aR as ee,aY as te,c as j,r as l,aF as oe,aE as se,b7 as H,b4 as ne,aG as n,aH as r,aI as e,aN as h,aJ as f,aM as y,aO as B,aW as S,aK as re,aL as ae,aU as le,aV as ie,b8 as de,aX as D,aQ as K,b0 as ce,b9 as C,o as F}from"./index-BYuuB5GE.js";import{u as ue}from"./complaintStore-CQRCRmNB.js";const ve={class:"chat-header"},ge={class:"header-info"},he={class:"header-title"},we={class:"status-info"},pe={class:"category"},ke={key:0,class:"loading-state"},me={key:1,class:"error-state"},fe={key:2,class:"messages-list"},ye={class:"message-avatar"},Ce={key:0,width:"16",height:"16",viewBox:"0 0 24 24",fill:"none",xmlns:"http://www.w3.org/2000/svg"},be={key:1,width:"16",height:"16",viewBox:"0 0 24 24",fill:"none",xmlns:"http://www.w3.org/2000/svg"},xe={class:"message-content"},Me={class:"message-bubble"},_e=["onClick"],Le=["src"],Ie={key:1,class:"message-text"},je={class:"message-time"},Be={class:"message-input-container"},Te={key:0,class:"closed-notice"},Ee=["disabled"],Ve={class:"input-wrapper"},He=["onKeydown","placeholder","disabled"],Se={key:0,class:"upload-indicator"},De=["disabled","title"],Ke={key:1,class:"image-upload"},Fe={class:"upload-options"},Ue={class:"media-container"},Ne=["src"],$e=["src"],ze={__name:"ComplaintChat",setup(Pe){const U=Z(),N=ee(),a=ue(),g=te(),w=j(()=>N.params.id),c=l(""),p=l(!1),M=l(!1),v=l(""),k=l(!1),_=l(null),b=l(null),x=l(null),L=l(0),I=l(!1),i=j(()=>a.currentComplaint),u=j(()=>i.value?.status==="Closed"),T=()=>{U.go(-1)},$=()=>{p.value=!p.value},z=()=>{document.fullscreenElement?document.exitFullscreen():document.documentElement.requestFullscreen()},E=()=>{M.value=!1,v.value=""},P=o=>o?[".jpg",".jpeg",".png",".gif",".webp",".svg"].some(s=>o.toLowerCase().includes(s)):!1,Y=()=>{if(v.value){const o=document.createElement("a");o.href=v.value,o.download=`complaint-media-${Date.now()}`,document.body.appendChild(o),o.click(),document.body.removeChild(o)}},A=o=>{o.shiftKey||(o.preventDefault(),V())},R=()=>{const o=x.value;o&&(o.style.height="auto",o.style.height=Math.min(o.scrollHeight,120)+"px")},W=async o=>{const t=o.target.files[0];if(t){if(t.size>5*1024*1024){g.showError("Image size must be less than 5MB");return}if(!t.type.startsWith("image/")){g.showError("Please select an image file");return}try{k.value=!0,p.value=!1;const s=await a.uploadImage(t,w.value),d=await F.getCurrentUser();if(!d){g.showError("You must be logged in to send messages.");return}await a.addMessage(w.value,{senderType:"user",senderId:d.uid,text:c.value||"Image message",imageUrl:s.url,imageFileName:s.fileName}),c.value="",m()}catch(s){console.error("Error uploading image:",s),g.showError("Failed to upload image. Please try again.")}finally{k.value=!1}}},V=async()=>{if(!(!c.value.trim()||a.loading||u.value))try{const o=await F.getCurrentUser();if(!o){g.showError("You must be logged in to send messages.");return}await a.addMessage(w.value,{senderType:"user",senderId:o.uid,text:c.value.trim()}),c.value="",m()}catch(o){console.error("Error sending message:",o),g.showError("Failed to send message. Please try again.")}},G=o=>{v.value=o,M.value=!0},m=()=>{H(()=>{b.value&&(b.value.scrollTop=b.value.scrollHeight)})},J=o=>{const t=a.complaintCategories.find(s=>s.id===o);return t?t.name:"Other"},O=o=>{if(!o)return"";const t=o.toDate?o.toDate():new Date(o),d=(new Date-t)/(1e3*60);return d<1?"Just now":d<60?`${Math.floor(d)}m ago`:d<1440?`${Math.floor(d/60)}h ago`:t.toLocaleDateString()},q=async()=>{try{C.addListener("keyboardWillShow",o=>{console.log("Keyboard will show:",o),L.value=o.keyboardHeight,I.value=!0,setTimeout(()=>{m()},100)}),C.addListener("keyboardWillHide",()=>{console.log("Keyboard will hide"),L.value=0,I.value=!1}),await C.setResizeMode({mode:"ionic"}),await C.setScroll({isDisabled:!1})}catch(o){console.log("Keyboard API not available:",o)}},Q=async()=>{try{await C.removeAllListeners()}catch(o){console.log("Error cleaning up keyboard listeners:",o)}};return oe(()=>i.value?.messages?.length,()=>{m()}),se(async()=>{try{await a.fetchComplaint(w.value),_.value=a.subscribeToComplaint(w.value),q(),H(()=>{x.value&&x.value.focus()}),m()}catch(o){console.error("Error loading complaint:",o)}}),ne(()=>{_.value&&_.value(),Q()}),(o,t)=>(r(),n("div",{class:y(["complaint-chat",{"keyboard-visible":I.value}]),style:ce({"--keyboard-height":L.value+"px"})},[e("div",ve,[e("button",{onClick:T,class:"back-btn"},[...t[4]||(t[4]=[e("svg",{width:"20",height:"20",viewBox:"0 0 24 24",fill:"none",xmlns:"http://www.w3.org/2000/svg"},[e("path",{d:"M19 12H5M12 19L5 12L12 5",stroke:"currentColor","stroke-width":"2","stroke-linecap":"round","stroke-linejoin":"round"})],-1)])]),e("div",ge,[e("div",he,[e("h2",null,f(i.value?.title||"Complaint Chat"),1),e("div",we,[e("span",{class:y(["status-badge",i.value?.status?.toLowerCase().replace(" ","-")])},f(i.value?.status||"Loading..."),3),e("span",pe,f(J(i.value?.category)),1)])]),e("div",{class:"header-actions"},[e("button",{onClick:z,class:"action-btn",title:"Toggle Fullscreen"},[...t[5]||(t[5]=[e("svg",{width:"18",height:"18",viewBox:"0 0 24 24",fill:"none",xmlns:"http://www.w3.org/2000/svg"},[e("path",{d:"M8 3H5C3.89543 3 3 3.89543 3 5V8M21 3H19C17.8954 3 17 3.89543 17 5V8M3 16V19C3 20.1046 3.89543 21 5 21H8M16 21H19C20.1046 21 21 20.1046 21 19V16",stroke:"currentColor","stroke-width":"2","stroke-linecap":"round","stroke-linejoin":"round"})],-1)])])])])]),e("div",{class:"messages-container",ref_key:"messagesContainer",ref:b},[B(a).loading&&!i.value?(r(),n("div",ke,[...t[6]||(t[6]=[e("div",{class:"spinner"},null,-1),e("p",null,"Loading conversation...",-1)])])):i.value?(r(),n("div",fe,[(r(!0),n(re,null,ae(i.value.messages,s=>(r(),n("div",{key:s.id,class:y(["message-wrapper",s.senderType])},[e("div",ye,[e("div",{class:y(["avatar",s.senderType])},[s.senderType==="user"?(r(),n("svg",Ce,[...t[8]||(t[8]=[e("path",{d:"M20 21V19C20 17.9391 19.5786 16.9217 18.8284 16.1716C18.0783 15.4214 17.0609 15 16 15H8C6.93913 15 5.92172 15.4214 5.17157 16.1716C4.42143 16.9217 4 17.9391 4 19V21",stroke:"currentColor","stroke-width":"2","stroke-linecap":"round","stroke-linejoin":"round"},null,-1),e("circle",{cx:"12",cy:"7",r:"4",stroke:"currentColor","stroke-width":"2","stroke-linecap":"round","stroke-linejoin":"round"},null,-1)])])):(r(),n("svg",be,[...t[9]||(t[9]=[e("path",{d:"M12 2L2 7L12 12L22 7L12 2Z",stroke:"currentColor","stroke-width":"2","stroke-linecap":"round","stroke-linejoin":"round"},null,-1),e("path",{d:"M2 17L12 22L22 17",stroke:"currentColor","stroke-width":"2","stroke-linecap":"round","stroke-linejoin":"round"},null,-1),e("path",{d:"M2 12L12 17L22 12",stroke:"currentColor","stroke-width":"2","stroke-linecap":"round","stroke-linejoin":"round"},null,-1)])]))],2)]),e("div",xe,[e("div",Me,[s.imageUrl?(r(),n("div",{key:0,class:"message-image",onClick:d=>G(s.imageUrl)},[e("img",{src:s.imageUrl,alt:"Image message"},null,8,Le),t[10]||(t[10]=e("div",{class:"image-overlay"},[e("svg",{width:"24",height:"24",viewBox:"0 0 24 24",fill:"none",xmlns:"http://www.w3.org/2000/svg"},[e("path",{d:"M15 3H21V9M21 3L3 21M21 3V9H15",stroke:"currentColor","stroke-width":"2","stroke-linecap":"round","stroke-linejoin":"round"})])],-1))],8,_e)):h("",!0),s.text?(r(),n("div",Ie,f(s.text),1)):h("",!0),e("div",je,f(O(s.timestamp)),1)])])],2))),128))])):(r(),n("div",me,[t[7]||(t[7]=S('<div class="error-icon" data-v-3c397fa8><svg width="64" height="64" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-3c397fa8><circle cx="12" cy="12" r="10" stroke="#fbbf24" stroke-width="2" data-v-3c397fa8></circle><line x1="12" y1="8" x2="12" y2="12" stroke="#fbbf24" stroke-width="2" stroke-linecap="round" data-v-3c397fa8></line><line x1="12" y1="16" x2="12.01" y2="16" stroke="#fbbf24" stroke-width="2" stroke-linecap="round" data-v-3c397fa8></line></svg></div><h3 class="error-title" data-v-3c397fa8>Complaint Not Found</h3><p class="error-message" data-v-3c397fa8>The complaint you&#39;re looking for doesn&#39;t exist or has been deleted.</p>',3)),e("button",{onClick:T,class:"btn-primary"},"Go Back")]))],512),e("div",Be,[u.value?(r(),n("div",Te,[...t[11]||(t[11]=[S('<div class="closed-notice-content" data-v-3c397fa8><svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-3c397fa8><circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="2" data-v-3c397fa8></circle><line x1="15" y1="9" x2="9" y2="15" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" data-v-3c397fa8></line><line x1="9" y1="9" x2="15" y2="15" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" data-v-3c397fa8></line></svg><span data-v-3c397fa8>This complaint has been closed. You can view the conversation but cannot send new messages.</span></div>',1)])])):h("",!0),e("div",{class:y(["message-input",{disabled:u.value}])},[e("button",{onClick:$,class:"attachment-btn",disabled:k.value||u.value,title:"Attach Image"},[...t[12]||(t[12]=[e("svg",{width:"20",height:"20",viewBox:"0 0 24 24",fill:"none",xmlns:"http://www.w3.org/2000/svg"},[e("path",{d:"M21.44 11.05L12.25 20.24C11.1242 21.3658 9.59722 21.9983 8.005 21.9983C6.41278 21.9983 4.88583 21.3658 3.76 20.24C2.63417 19.1142 2.00167 17.5872 2.00167 15.995C2.00167 14.4028 2.63417 12.8758 3.76 11.75L12.95 2.56C13.7006 1.80944 14.7186 1.38787 15.79 1.38787C16.8614 1.38787 17.8794 1.80944 18.63 2.56C19.3806 3.31056 19.8021 4.32856 19.8021 5.4C19.8021 6.47144 19.3806 7.48944 18.63 8.24L9.41 17.46C9.03473 17.8353 8.53127 18.0499 8.005 18.0499C7.47873 18.0499 6.97527 17.8353 6.6 17.46C6.22473 17.0847 6.01013 16.5813 6.01013 16.055C6.01013 15.5287 6.22473 15.0253 6.6 14.65L15.07 6.18",stroke:"currentColor","stroke-width":"2","stroke-linecap":"round","stroke-linejoin":"round"})],-1)])],8,Ee),e("div",Ve,[le(e("textarea",{ref_key:"messageInput",ref:x,"onUpdate:modelValue":t[0]||(t[0]=s=>c.value=s),onKeydown:de(D(A,["prevent"]),["enter"]),onInput:R,placeholder:u.value?"This complaint is closed":"Type your message...",disabled:B(a).loading||u.value,rows:"1",class:"message-textarea"},null,40,He),[[ie,c.value]]),k.value?(r(),n("div",Se,[...t[13]||(t[13]=[e("div",{class:"upload-spinner"},null,-1)])])):h("",!0)]),e("button",{onClick:V,disabled:!c.value.trim()||B(a).loading||k.value||u.value,class:"send-btn",title:u.value?"Cannot send messages to closed complaints":"Send Message"},[...t[14]||(t[14]=[e("svg",{width:"20",height:"20",viewBox:"0 0 24 24",fill:"none",xmlns:"http://www.w3.org/2000/svg"},[e("path",{d:"M22 2L11 13M22 2L15 22L11 13M22 2L2 9L11 13",stroke:"currentColor","stroke-width":"2","stroke-linecap":"round","stroke-linejoin":"round"})],-1)])],8,De)],2),p.value?(r(),n("div",Ke,[e("input",{ref:"imageInput",type:"file",accept:"image/*,video/*",onChange:W,style:{display:"none"}},null,544),e("div",Fe,[e("button",{onClick:t[1]||(t[1]=s=>o.$refs.imageInput.click()),class:"select-image-btn"},[...t[15]||(t[15]=[e("svg",{width:"18",height:"18",viewBox:"0 0 24 24",fill:"none",xmlns:"http://www.w3.org/2000/svg"},[e("rect",{x:"3",y:"3",width:"18",height:"18",rx:"2",ry:"2",stroke:"currentColor","stroke-width":"2"}),e("circle",{cx:"8.5",cy:"8.5",r:"1.5",stroke:"currentColor","stroke-width":"2"}),e("polyline",{points:"21,15 16,10 5,21",stroke:"currentColor","stroke-width":"2"})],-1),K(" Select Image/Video ",-1)])]),e("button",{onClick:t[2]||(t[2]=s=>p.value=!1),class:"cancel-btn"},[...t[16]||(t[16]=[e("svg",{width:"18",height:"18",viewBox:"0 0 24 24",fill:"none",xmlns:"http://www.w3.org/2000/svg"},[e("line",{x1:"18",y1:"6",x2:"6",y2:"18",stroke:"currentColor","stroke-width":"2","stroke-linecap":"round","stroke-linejoin":"round"}),e("line",{x1:"6",y1:"6",x2:"18",y2:"18",stroke:"currentColor","stroke-width":"2","stroke-linecap":"round","stroke-linejoin":"round"})],-1),K(" Cancel ",-1)])])])])):h("",!0)]),M.value?(r(),n("div",{key:0,class:"fullscreen-modal",onClick:E},[e("div",{class:"fullscreen-content",onClick:t[3]||(t[3]=D(()=>{},["stop"]))},[e("div",{class:"fullscreen-header"},[e("button",{onClick:E,class:"close-btn"},[...t[17]||(t[17]=[e("svg",{width:"24",height:"24",viewBox:"0 0 24 24",fill:"none",xmlns:"http://www.w3.org/2000/svg"},[e("line",{x1:"18",y1:"6",x2:"6",y2:"18",stroke:"currentColor","stroke-width":"2","stroke-linecap":"round","stroke-linejoin":"round"}),e("line",{x1:"6",y1:"6",x2:"18",y2:"18",stroke:"currentColor","stroke-width":"2","stroke-linecap":"round","stroke-linejoin":"round"})],-1)])]),e("div",{class:"media-actions"},[e("button",{onClick:Y,class:"action-btn",title:"Download"},[...t[18]||(t[18]=[e("svg",{width:"20",height:"20",viewBox:"0 0 24 24",fill:"none",xmlns:"http://www.w3.org/2000/svg"},[e("path",{d:"M21 15V19C21 19.5304 20.7893 20.0391 20.4142 20.4142C20.0391 20.7893 19.5304 21 19 21H5C4.46957 21 3.96086 20.7893 3.58579 20.4142C3.21071 20.0391 3 19.5304 3 19V15",stroke:"currentColor","stroke-width":"2","stroke-linecap":"round","stroke-linejoin":"round"}),e("polyline",{points:"7,10 12,15 17,10",stroke:"currentColor","stroke-width":"2","stroke-linecap":"round","stroke-linejoin":"round"}),e("line",{x1:"12",y1:"15",x2:"12",y2:"3",stroke:"currentColor","stroke-width":"2","stroke-linecap":"round","stroke-linejoin":"round"})],-1)])])])]),e("div",Ue,[P(v.value)?(r(),n("img",{key:0,src:v.value,alt:"Image preview",class:"fullscreen-image"},null,8,Ne)):(r(),n("video",{key:1,src:v.value,controls:"",class:"fullscreen-video"}," Your browser does not support the video tag. ",8,$e))])])])):h("",!0)],6))}},Re=X(ze,[["__scopeId","data-v-3c397fa8"]]);export{Re as default};
