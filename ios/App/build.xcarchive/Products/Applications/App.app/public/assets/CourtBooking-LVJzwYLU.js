import{d as Z,r as k,f as M,aC as q,aD as J,u as Y,aY as X,b1 as x,c as j,aF as ee,aE as oe,aG as r,aH as i,aS as te,aT as se,aI as e,aJ as l,aN as N,aK as G,aL as L,aM as W,aO as ae,b0 as le,aQ as ne,o as re}from"./index-BYuuB5GE.js";import{b as E}from"./bookingService-DFeujY8_.js";const ie=Z("sportsStore",()=>{const C=k([]),d=k({}),f=k({}),w=k(!1),_=k(null),V=async n=>{if(!n){console.warn("No project ID provided to fetchSports"),C.value=[],d.value={},f.value={};return}try{w.value=!0,_.value=null,console.log("üöÄ SportsStore: Fetching courts for project:",n);const a=`projects/${n}/courts`,g={timeoutMs:6e3},F=await M.getDocs(a,g),b={},P=new Set;F.docs.forEach(u=>{const h=u.data(),v=h.sport;if(console.log("Processing court:",u.id,"with sport ID:",v),v){P.add(v),b[v]||(b[v]=[]);const Q={id:u.id,...h,unavailability:h.unavailability||[],imageUrl:h.imageUrl||null,imageFileName:h.imageFileName||null};b[v].push(Q)}}),console.log("Collected sport IDs:",Array.from(P)),console.log("Courts data structure:",b);const z=`projects/${n}/sports`,H={timeoutMs:6e3},R=await M.getDocs(z,H);console.log("Sports result size:",R.docs.length);const I=[],A=new Set;R.docs.forEach(u=>{const h=u.data(),v=u.id;A.add(v),console.log("Processing sport:",v,"with data:",h),b[v]&&b[v].length>0?(I.push({id:v,name:h.name||v,...h}),console.log("Added sport to sportsData:",v)):console.log("Skipped sport (no courts):",v)});for(const u of P)if(!A.has(u)){console.log("Sport not found, creating from court data:",u);const h=b[u][0];h&&(await m(n,u,h),I.push({id:u,name:u,description:`Sport for ${h.name||"court"}`,category:"General",active:!0}))}C.value=I.map(u=>u.name||u.id),d.value=b;const U={};I.forEach(u=>{const h=u.name||u.id;U[h]=u.id}),f.value=U,console.log(`Fetched ${I.length} sports with courts for project ${n}`),console.log("Sports found:",I),console.log("Courts by sport:",b),console.log("Sport name to ID map:",U)}catch(a){console.error("Error fetching sports:",a),a.value=a.message}finally{w.value=!1}},y=async(n,a)=>{if(!(!n||!a.trim()))try{await M.setDoc(`projects/${n}/sports/${a}`,{name:a,courts:[]}),C.value.includes(a)||C.value.push(a),d.value[a]=[],console.log(`Added Sport: ${a} to project ${n}`)}catch(g){throw console.error("Error adding sport:",g),g}},c=async(n,a,g)=>{(!n||!d.value[a])&&(d.value[a]=[]),d.value[a].push(g),await M.updateDoc(`projects/${n}/sports/${a}`,{courts:d.value[a]})},S=async(n,a,g,F)=>{if(!n||!d.value[a])return;const b=d.value[a].findIndex(P=>P.id===g);b!==-1&&(d.value[a][b]=F,await M.updateDoc(`projects/${n}/sports/${a}`,{courts:d.value[a]}))},p=()=>C.value.filter(n=>d.value[n]&&d.value[n].length>0),$=n=>{console.log("üîç getCourtsForSport called with sportName:",n),console.log("Available courtsBySport keys (sport IDs):",Object.keys(d.value)),console.log("Sport name to ID mapping:",f.value);const a=f.value[n];if(!a)return console.warn("‚ùå No sport ID found for name:",n),[];console.log(`üîç Mapped "${n}" to sport ID: "${a}"`);const g=d.value[a];return g&&g.length>0?(console.log(`‚úÖ Found ${g.length} court(s) for ${n}:`,g),g):(console.warn(`‚ùå No courts found for sport ID: ${a}`),[])},D=()=>{C.value=[],d.value={},f.value={},w.value=!1,_.value=null},O=()=>{D()},B=()=>{console.log("=== SPORTS STORE DEBUG ==="),console.log("sportsOptions:",C.value),console.log("courtsBySport:",d.value),console.log("sportNameToIdMap:",f.value),console.log("loading:",w.value),console.log("error:",_.value)},m=async(n,a,g)=>{try{return await M.setDoc(`projects/${n}/sports/${a}`,{name:a,description:`Sport for ${g.name||"court"}`,category:"General",active:!0,createdAt:new Date().toISOString()}),console.log("Created sport from court data:",a),!0}catch(F){return console.error("Error creating sport from court:",F),!1}};return{sportsOptions:C,courtsBySport:d,sportNameToIdMap:f,loading:w,error:_,fetchSports:V,addSport:y,addCourt:c,updateCourt:S,getSportsWithCourts:p,getCourtsForSport:$,clearData:D,resetForNewProject:O,debugSportsData:B,createSportFromCourt:m}}),ce={class:"court-booking-page"},ue={key:0,class:"loading-state"},de={key:1,class:"error-state"},ve={key:2,class:"no-project-state"},pe={key:3,class:"no-sports-state"},ge={key:4,class:"booking-content"},me={class:"booking-section"},he={class:"section-title"},fe={class:"section-subtitle"},ye={class:"sport-options"},Se=["onClick"],be={class:"sport-info"},ke={class:"sport-name"},_e={class:"court-count"},Ce={key:0,class:"booking-section"},De={class:"section-subtitle"},we={class:"court-options"},$e=["onClick"],Pe={key:0,class:"court-image"},Ie=["src","alt"],Ae={key:1,class:"court-image-placeholder"},Te={class:"court-info"},Be={class:"court-location"},Fe={class:"court-details"},je={class:"court-type"},Ne={class:"court-surface"},Ee={class:"court-capacity"},Oe={class:"court-pricing"},Me={class:"price"},Ue={key:1,class:"booking-section"},Re={class:"date-options"},Ge=["onClick"],Le={class:"date-day"},We={class:"date-number"},Ve={class:"date-month"},ze={key:0,class:"closed-badge"},He={key:2,class:"booking-section"},Qe={class:"section-subtitle"},Ke={key:0,class:"time-slots-loading"},Ze={key:1,class:"time-options"},qe=["onClick"],Je={key:0,class:"reserved-label"},Ye={key:3,class:"booking-summary"},Xe={class:"summary-content"},xe={class:"summary-item"},eo={class:"value"},oo={class:"summary-item"},to={class:"value"},so={class:"summary-item"},ao={class:"value"},lo={class:"summary-item"},no={class:"value"},ro={class:"summary-item"},io={class:"value"},co={class:"summary-item total"},uo={class:"value"},vo=["disabled"],po={key:0},go={key:1},mo=Object.assign({name:"CourtBookingPage"},{__name:"CourtBooking",setup(C){const d=J(),f=ie(),w=Y(),_=X(),V=x(),y=k(null),c=k(null),S=k(null),p=k([]),$=k(!1),D=k(null),O=k(!1),B=k([]),m=j(()=>w.selectedProject?.id),n=j(()=>w.selectedProject?.name),a=j(()=>f.sportsOptions),g=j(()=>{const s=E.generateAvailableDays();if(!c.value||!c.value.availability)return s.map(t=>({date:t,enabled:!0}));const o=["sunday","monday","tuesday","wednesday","thursday","friday","saturday"];return s.map(t=>{const T=o[t.getDay()],K=c.value.availability[T];return{date:t,enabled:K?K.enabled:!0,dayOfWeek:T}})}),F=j(()=>!S.value||!c.value||!m.value?[]:B.value.length>0?B.value:E.generateTimeSlots()),b=j(()=>!c.value||p.value.length===0?0:E.calculatePrice(c.value.hourlyRate,p.value)),P=j(()=>{if(!y.value)return[];const s=f.getCourtsForSport(y.value);return console.log(`üìã Available courts for ${y.value}:`,s),s}),z=s=>{console.log("üèÄ Sport selected:",s),y.value=s,c.value=null,S.value=null,p.value=[],console.log("Available courts after sport selection:",P.value)},H=s=>{c.value=s,S.value=null,p.value=[],B.value=[]},R=async s=>{if(S.value=s,p.value=[],c.value&&m.value)try{$.value=!0;const o=await E.getAvailableTimeSlotsOptimized(m.value,c.value.id,s.toISOString().split("T")[0],c.value);B.value=o,console.log("Fetched time slots with availability:",o)}catch(o){console.error("Error fetching available time slots:",o),B.value=E.generateTimeSlots()}finally{$.value=!1}},I=s=>{const o=p.value.indexOf(s);o>-1?p.value.splice(o,1):p.value.push(s)},A=s=>E.formatDate(s),U=s=>s?s.charAt(0).toUpperCase()+s.slice(1).replace(/([A-Z])/g," $1"):"Unknown",u=async()=>{await v()},h=async()=>{if(!m.value){_.showWarning("No project selected. Please select a project first.");return}const s=await re.getCurrentUser();if(!s){_.showWarning("Please log in to book a court.");return}try{if(!y.value||!c.value||!S.value||p.value.length===0){_.showWarning("Please complete all selections before confirming");return}O.value=!0,_.showInfo("Creating your booking...");const o={userId:s.uid,sport:y.value,courtId:c.value.id,courtName:c.value.name,date:S.value.toISOString().split("T")[0],timeSlots:p.value,totalPrice:b.value,sportType:y.value,courtLocation:c.value.location,courtType:c.value.type,courtSurface:c.value.surface};console.log("Creating booking with data:",o),console.log("User ID:",s.uid),console.log("Project ID:",m.value);const t=await E.createCourtBooking(m.value,o);console.log("üîç Court booking result:",t),t.success&&t.bookingId?(_.showSuccess(`Booking request submitted! Awaiting admin confirmation. Booking ID: ${t.bookingId}`),await new Promise(T=>setTimeout(T,500)),await V.fetchUserBookings(s.uid,m.value),setTimeout(()=>{d.push("/my-bookings")},2e3)):(console.error("‚ùå Court booking failed:",t),_.showError("Failed to create booking. Please try again."))}catch(o){console.error("Error confirming booking:",o),_.showError(`Failed to confirm booking: ${o.message||"Please try again."}`)}finally{O.value=!1}},v=async()=>{if(!m.value){D.value="No project selected. Please select a project first.";return}try{$.value=!0,D.value=null,await f.fetchSports(m.value)}catch(s){D.value="Failed to load sports and courts. Please try again.",console.error("Error fetching sports:",s)}finally{$.value=!1}},Q=()=>{console.log("=== COURT BOOKING DEBUG ==="),console.log("Current Sports Options:",f.sportsOptions),console.log("Current Project ID:",m.value),console.log("Current Selected Sport:",y.value),console.log("Current Selected Court:",c.value),console.log("Current Selected Day:",S.value),console.log("Current Selected Slots:",p.value),f.debugSportsData(),console.log("Attempting to fetch sports again..."),v()};return ee(m,s=>{s?(y.value=null,c.value=null,S.value=null,p.value=[],v()):f.resetForNewProject()}),oe(async()=>{m.value?await v():D.value="No project selected. Please select a project first."}),(s,o)=>(i(),r("div",ce,[te(se,{title:s.$t("courtBookingTitle"),subtitle:n.value?`${s.$t("bookCourtsIn")} ${n.value}`:s.$t("chooseSportCourtDateTime")},null,8,["title","subtitle"]),$.value?(i(),r("div",ue,[o[1]||(o[1]=e("div",{class:"loading-spinner"},null,-1)),e("p",null,l(s.$t("loadingAvailableCourts")),1)])):D.value?(i(),r("div",de,[o[2]||(o[2]=e("div",{class:"error-icon"},"‚ö†Ô∏è",-1)),e("p",null,l(D.value),1),e("button",{onClick:u,class:"retry-btn"},l(s.$t("tryAgain")),1)])):m.value?a.value.length===0?(i(),r("div",pe,[o[4]||(o[4]=e("div",{class:"no-sports-icon"},"üèüÔ∏è",-1)),e("h3",null,l(s.$t("noSportsAvailable")),1),e("p",null,l(s.$t("noSportsMessage")),1),e("p",null,l(s.$t("contactAdminForCourts")),1),m.value?(i(),r("button",{key:0,onClick:Q,class:"debug-btn"},l(s.$t("debugSportsData")),1)):N("",!0)])):(i(),r("div",ge,[e("div",me,[e("h2",he,l(s.$t("selectSport")),1),e("p",fe,l(s.$t("chooseSportDesc")),1),e("div",ye,[(i(!0),r(G,null,L(a.value,t=>(i(),r("div",{key:t,class:W(["sport-option",{active:y.value===t}]),onClick:T=>z(t)},[e("div",be,[e("span",ke,l(t),1),e("span",_e,l(ae(f).getCourtsForSport(t).length)+" court(s)",1)])],10,Se))),128))])]),y.value?(i(),r("div",Ce,[o[7]||(o[7]=e("h2",{class:"section-title"},"Select Court",-1)),e("p",De,"Available courts for "+l(y.value),1),e("div",we,[(i(!0),r(G,null,L(P.value,t=>(i(),r("div",{key:t.id,class:W(["court-option",{active:c.value?.id===t.id}]),onClick:T=>H(t)},[t.imageUrl?(i(),r("div",Pe,[e("img",{src:t.imageUrl,alt:t.name},null,8,Ie)])):(i(),r("div",Ae,[...o[5]||(o[5]=[e("svg",{width:"48",height:"48",viewBox:"0 0 24 24",fill:"none",xmlns:"http://www.w3.org/2000/svg"},[e("path",{d:"M4 16L8.586 11.414C9.367 10.633 10.633 10.633 11.414 11.414L16 16M14 14L15.586 12.414C16.367 11.633 17.633 11.633 18.414 12.414L20 14M14 8H14.01M6 20H18C19.105 20 20 19.105 20 18V6C20 4.895 19.105 4 18 4H6C4.895 4 4 4.895 4 6V18C4 19.105 4.895 20 6 20Z",stroke:"#9CA3AF","stroke-width":"2","stroke-linecap":"round","stroke-linejoin":"round"})],-1)])])),e("div",Te,[e("h3",null,l(t.name),1),e("p",Be,l(t.location),1),e("p",Fe,[e("span",je,l(t.type),1),e("span",Ne,l(U(t.surface)),1),e("span",Ee,l(t.capacity)+" people",1)])]),e("div",Oe,[e("span",Me,l(t.hourlyRate)+" EGP/hour",1),o[6]||(o[6]=e("span",{class:"status-badge available"},"Available",-1))])],10,$e))),128))])])):N("",!0),c.value?(i(),r("div",Ue,[o[8]||(o[8]=e("h2",{class:"section-title"},"Select Date",-1)),o[9]||(o[9]=e("p",{class:"section-subtitle"},"Choose from the next 7 days",-1)),e("div",Re,[(i(!0),r(G,null,L(g.value,t=>(i(),r("div",{key:t.date.toISOString(),class:W(["date-option",{active:S.value?.toDateString()===t.date.toDateString(),disabled:!t.enabled}]),onClick:T=>t.enabled?R(t.date):null},[e("div",Le,l(A(t.date).split(" ")[0]),1),e("div",We,l(A(t.date).split(" ")[1]),1),e("div",Ve,l(A(t.date).split(" ")[2]),1),t.enabled?N("",!0):(i(),r("div",ze,"Closed"))],10,Ge))),128))])])):N("",!0),S.value&&c.value?(i(),r("div",He,[o[11]||(o[11]=e("h2",{class:"section-title"},"Select Time Slots",-1)),e("p",Qe,"Available time slots for "+l(A(S.value)),1),$.value?(i(),r("div",Ke,[...o[10]||(o[10]=[e("div",{class:"loading-spinner"},null,-1),e("span",null,"Loading available slots...",-1)])])):(i(),r("div",Ze,[(i(!0),r(G,null,L(F.value,t=>(i(),r("div",{key:t.time,class:W(["time-slot",{active:p.value.includes(t.time),reserved:t.isReserved}]),onClick:T=>I(t.time),style:le({pointerEvents:t.isReserved?"none":"auto"})},[ne(l(t.time)+" ",1),t.isReserved?(i(),r("span",Je,"Booked")):N("",!0)],14,qe))),128))]))])):N("",!0),p.value.length>0?(i(),r("div",Ye,[o[18]||(o[18]=e("div",{class:"summary-header"},[e("h2",null,"Booking Summary")],-1)),e("div",Xe,[e("div",xe,[o[12]||(o[12]=e("span",{class:"label"},"Sport:",-1)),e("span",eo,l(y.value),1)]),e("div",oo,[o[13]||(o[13]=e("span",{class:"label"},"Court:",-1)),e("span",to,l(c.value?.name),1)]),e("div",so,[o[14]||(o[14]=e("span",{class:"label"},"Date:",-1)),e("span",ao,l(S.value?A(S.value):""),1)]),e("div",lo,[o[15]||(o[15]=e("span",{class:"label"},"Time:",-1)),e("span",no,l(p.value.join(", ")),1)]),e("div",ro,[o[16]||(o[16]=e("span",{class:"label"},"Duration:",-1)),e("span",io,l(p.value.length)+" hour(s)",1)]),e("div",co,[o[17]||(o[17]=e("span",{class:"label"},"Total Price:",-1)),e("span",uo,l(b.value)+" EGP",1)])]),e("button",{class:"confirm-booking-btn",onClick:h,disabled:O.value},[O.value?(i(),r("span",po,"Processing...")):(i(),r("span",go,"Confirm Booking"))],8,vo)])):N("",!0)])):(i(),r("div",ve,[o[3]||(o[3]=e("div",{class:"no-project-icon"},"üèóÔ∏è",-1)),e("h3",null,l(s.$t("noProjectSelected")),1),e("p",null,l(s.$t("selectProjectToBookCourts")),1),e("button",{onClick:o[0]||(o[0]=t=>s.$router.push("/project-selection")),class:"select-project-btn"},l(s.$t("switchProject")),1)]))]))}}),yo=q(mo,[["__scopeId","data-v-29e70ec3"]]);export{yo as default};
